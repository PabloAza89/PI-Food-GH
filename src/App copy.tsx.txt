import { useState, useEffect, useRef } from "react";
import css from './App.module.css';
import './commons/globalSweetAlert2.css';
import { checkPrevLogin } from './commons/commonsFunc';
import { useSelector } from 'react-redux';
import { Route, Routes, useLocation, useMatch } from "react-router-dom";
import Landing from "./components/Landing/Landing";
import CardsMapper from "./components/CardsMapper/CardsMapper";
import GoogleAuth from './components/GoogleAuth/GoogleAuth';
import Detail from "./components/Detail/Detail";
import GoBack from "./components/GoBack/GoBack";
import Paginate from "./components/Paginate/Paginate";
import NavBar from "./components/NavBar/NavBar";
import GoUp from "./components/GoUp/GoUp";
import ServerStatus from "./components/ServerStatus/ServerStatus";
import Error from './components/Error/Error';
import MyRecipe from "./components/MyRecipe/MyRecipe";
import About from "./components/About/About";
import { userDataObjI } from './interfaces/interfaces';
import { useDispatch } from 'react-redux';
import {
  fetchRecipesFromAPI, allRecipesLoaded,
  setCurrentWidth, setHeight, setPercentageResizedHeight, setWidth,
  setScrollWidth, setHasScroll, setScrollPosition,
  getDietsFromDB, viewPort, landingHidden
} from './actions';
import store from './store/store';
import $ from 'jquery';

function App() {

  

  // useEffect(() => {

  //   console.log("ASDASDASD typeof window.name" , window.name)

  // if (window.name === "") {
  //   console.log("ASDASDASD IS THE FIRST")
  //   window.name = "myWindow"
  // } else {
  //   console.log("ASDASDASD OTHER OPEN")
  // }

  // },[])

  //if (window.name === "myWindow") console.log("ASD ASD ASD IS THE FIRST")

  //window.name = "myWindow";

  //if (window.name === "myWindow") console.log("ASD ASD ASD OTHER OPEN")

  

  const dispatch = useDispatch()

  //let landHiddenLS: string | null = localStorage.getItem('landHidden');
  //if (landHiddenLS && JSON.parse(landHiddenLS)) dispatch(landingShown(true))

  const location = useLocation()
  const showHelpBG = [useMatch("/:route")?.params.route?.toLowerCase()].filter(e => e !== "about")[0]

  let landingHiddenLS: string | null = localStorage.getItem('landingHidden');
  let newLoginLS: string | null = localStorage.getItem('newLogin');

  //console.log(`LLRR showHelpNavbar`, showHelpBG)

  useEffect(() => {
    $(function() {
      var scrollDiv = document.createElement("div"); // Creates the div
      scrollDiv.className = "scrollbar-measure";
      document.body.appendChild(scrollDiv);
      $(`.scrollbar-measure`)
        .css("overflowY", "scroll") // Creates a ScrollBar
        .css("width", "fit-content") // Set width to auto considering the ScrollBar width
      typeof scrollDiv.offsetWidth === 'number' ? dispatch(setScrollWidth(scrollDiv.offsetWidth)) : dispatch(setScrollWidth(0))
      document.body.removeChild(scrollDiv); // Delete the div
    })
  },[dispatch])

  const currentWidth = useSelector((state: {currentWidth:number}) => state.currentWidth)
  const landingHidden = useSelector((state: { landingHidden: boolean }) => state.landingHidden)

  const [isLoading, setIsLoading] = useState({
    main: true,
    refresh: false
  });

  const [ userData, setUserData ] = useState<userDataObjI>({
    email: '',
    fd_tkn: ''
  })

  const retrieveLogin = (props: any) => {
    setUserData({ email: props.email, fd_tkn: props.fd_tkn })
  }

  const [ recipeCreatedOrEdited, setRecipeCreatedOrEdited ] = useState<boolean>(false)

  const retrieveRecipeCreatedOrEdited = (response: boolean) => {
    setRecipeCreatedOrEdited(response)
  }

  const [ recipeNotFound, setRecipeNotFound ] = useState<boolean>(false)

  const retrieveRecipeNotFound = (response: boolean) => {
    console.log("SE EJECUTO")
    setRecipeNotFound(response)
  }

  //let tabIDCopy: number
  const tabIDCopy = useRef(0)
  //const eDataCopy = useRef<Array<number>>()
  //const eDataCopy: any = useRef()
  //const eDataCopy = useRef<(HTMLDivElement | null)[]>()
  //const eDataCopy = useRef<(Array[] | number[])[]>()
  //const eDataCopy = useRef<number[]>()
  const eDataCopy: any = useRef()
  //const eDataCopy = useRef<any>()

  //const eDataCopy2: any

  const bc = new BroadcastChannel("test_channel");

  useEffect(() => { // FIRST ONLY-ONE-TIME AUTO-CHECK USER (CHECK USER TOKEN)

    const tabID = Math.floor(100000 + Math.random() * 900000)

    tabIDCopy.current = tabID

    //let arrTabID = [tabID]
    let arrTabID = { subscribe: [tabID], unsubscribe: [] }
    //let arrTabID = { subscribe: [], unsubscribe: [] }

    //const bc = new BroadcastChannel("test_channel");
    //bc.postMessage("This is a test message.");

    //let arrTabID = [tabID]
    
    //bc.postMessage({ subscribe: arrTabID, unsubscribe: [] });
    bc.postMessage(arrTabID);

    eDataCopy.current = { subscribe: [tabID], unsubscribe: [] }

    bc.onmessage = (e) => {
      console.log(" aver que llega", e.data)

      if (e.data.unsubscribe && e.data.unsubscribe.length !== 0) {
        console.log("ENTRO ACA UNSUBSCRIBE")
        //eDataCopy.current = eDataCopy.current && eDataCopy.current.subscribe.filter((e:any) => e !== e.data.unsubscribe[0])
        //e.data.subscribe.filter((e:any) => e !== e.data.unsubscribe[0])
        //let rr = eDataCopy.current.subscribe.filter((e:any) => e !== e.data.unsubscribe[0])
        let rr = eDataCopy.current.subscribe
        let qq = e.data.unsubscribe[0]
        let ss = rr.filter((e:any) => e !== qq)
        console.log("RRRRRRRRRRRRR 1", eDataCopy.current.subscribe)
        console.log("RRRRRRRRRRRRR 2", e.data.unsubscribe[0])
        console.log("RRRRRRRRRRRRR 3", ss)
        //eDataCopy.current = { subscribe: ss, unsubscribe: [] }

        

        //return 

        console.log("e.data.subscribe.length", e.data.subscribe.length)
        console.log("eDataCopy.current.subscribe.length", eDataCopy.current.subscribe.length)

        if (e.data.subscribe.length > eDataCopy.current.subscribe.length) { // TESTING
          console.log("TEST aditional", eDataCopy.current)
          //eDataCopy.current.subscribe = ss
          console.log("TEST 1", eDataCopy.current)
          return eDataCopy.current.subscribe = e.data.subscribe
          
          //return bc.postMessage({ subscribe: ss, unsubscribe: [] })
        } else {
          console.log("TEST 2", eDataCopy.current)
          return eDataCopy.current.subscribe = ss
        }


        //bc.postMessage({ subscribe: ss, unsubscribe: [] })
        //bc.postMessage(ss)
        //console.log("RRRRRRRRRRRRR", eDataCopy.current.subscribe.filter((e:any) => e !== e.data.unsubscribe[0]))
        //console.log("RRRRRRRRRRRRR", rr)
        //bc.postMessage()
      }
      
      if (e.data.subscribe && e.data.subscribe.length !== 0) {
        console.log("ENTRO EN ESTE OTRO")
        console.log("ENTRO EN ESTE OTRO", e.data.subscribe)
        
        //if (e.data.unsubscribe && e.data.unsubscribe.length) {
        //if (e.data.unsubscribe && e.data.hasOwnProperty("unsubscribe")) {
        
        // if (e.data.subscribe.length > eDataCopy.current.subscribe.length) {
        //   eDataCopy.current.subscribe = e.data.subscribe
        // }

        
        if (!e.data.subscribe.includes(tabIDCopy.current)) {

          console.log("LLEGO A ENTRAR ACA", tabID)
          //e.data.subscribe.push(tabID)
          //eDataCopy.current.subscribe.push(tabIDCopy.current)
          eDataCopy.current.subscribe.push(e.data.subscribe[0])
          //eDataCopy.current = e.data
          console.log("eDataCopy.current ADENTRO", eDataCopy.current)
          //bc.postMessage(eDataCopy.current);

        }





        //}
        // else {
        //   eDataCopy.current = e.data
        // }
        // } else {
        //   eDataCopy.current = [tabID]
        // }
        
        //console.log("SARARA 1",e.data);
      }
      //console.log("SARARA 0 ",e.data);
      console.log("SARARA 0 ", eDataCopy.current);
      
    };

    

    let tabsLS: string | null = localStorage.getItem('tabsLS');

    console.log("UNA SOLA VEZ EJECUTADO")

    sessionStorage.setItem('tabID', JSON.stringify(tabID))

    // if (!(tabsLS && JSON.parse(tabsLS))) {
    //   do {
    //     localStorage.setItem('tabsLS', JSON.stringify([tabID]))
    //     console.log("TIME 1")
    //   }
    //   while (
    //     !localStorage.getItem('tabsLS')
    //   )
      
    // }
    // else {
    //   do {
    //     let tabsLS: string | null = localStorage.getItem('tabsLS');
    //     let tabsLSParsed = tabsLS && JSON.parse(tabsLS)
    //     //let tabIndexInLS = tabsLS && JSON.parse(tabsLS).map((e: any, i: any) => { return e === tabID ? i : undefined }).filter((e: any) => e !== undefined)[0]
    //     tabsLSParsed.push(tabID)
    //     localStorage.setItem('tabsLS', JSON.stringify(tabsLSParsed))
        
    //  }
    //   while (
    //     !(JSON.parse(localStorage.getItem('tabsLS')!).includes(tabID))
    //   )

    // }

    console.log("AUTO-CHECK")
    fetch(`http://localhost:3001/user`, {
      method: 'POST',
      credentials: 'include',
      headers: {
        'Content-type': 'application/json; charset=UTF-8',
      },
      // body: JSON.stringify({
      //   email: userData.email,
      //   fd_tkn: userData.fd_tkn
      // })
    })
    .then((res) => res.json())
    .then((res) => {
      console.log("RES APP", res)
      setUserData({ email: res.email, fd_tkn: res.fd_tkn })
    })
    .catch(rej => console.log(rej))

    // return () => {
    //   //if (recipeCreated.current) clearHandler() // CLEAR FORM: SAVED && FIRES WHEN USER GO TO ANOTHER ROUTE/COMPONENT
    //   console.log("GOING TO ANOTHER COMPONENT")
    // }

    //console.log("TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT")
    // return () => {
    //   //if (recipeCreated.current) clearHandler() // CLEAR FORM: SAVED && FIRES WHEN USER GO TO ANOTHER ROUTE/COMPONENT
    //   console.log("TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT")
    // }

    // return () => {
    //   //if (recipeCreated.current) clearHandler() // CLEAR FORM: SAVED && FIRES WHEN USER GO TO ANOTHER ROUTE/COMPONENT
    //   console.log("CLOSED TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT")
    // }

  },[])

  useEffect(() => {
    function handleResize() {
      let windowScreenWidth = window.screen.width
      let windowScreenHeight = window.screen.height
      let windowInnerWidth = window.innerWidth
      dispatch(setWidth(windowScreenWidth))
      dispatch(setHeight(windowScreenHeight))
      dispatch(setCurrentWidth(windowInnerWidth))
      dispatch(setPercentageResizedHeight(window.innerHeight / windowScreenHeight))
      dispatch(setHasScroll(windowInnerWidth !== $('body').width() ? true : false))
      if (window.matchMedia("(orientation: portrait)").matches) {
        if (windowScreenWidth < 425) dispatch(viewPort(`smaPort`))
        else if (windowScreenWidth > 825) dispatch(viewPort(`larPort`))
        else dispatch(viewPort(`medPort`))
      } else {
        if (windowScreenHeight < 425) dispatch(viewPort(`smaLand`))
        else if (windowScreenHeight > 825) dispatch(viewPort(`larLand`))
        else dispatch(viewPort(`medLand`))
      }
    }
    function scrollHandler() { dispatch(setScrollPosition($(window).scrollTop() as number)) }
    window.addEventListener("scroll", scrollHandler);
    window.addEventListener("resize", handleResize);
    return () => {
      window.removeEventListener("resize", handleResize);
      window.removeEventListener("scroll", scrollHandler);
    }
  },[dispatch]);
  //})

  //.then(() => console.log("asd"))

  // dispatch(setHasScroll(window.innerWidth !== $('body').width() ? true : false))
  // dispatch(setHasScroll(window.innerWidth !== $('body').width() ? true : false))

  // console.log("CC window.innerWidth", window.innerWidth)
  // console.log("CC $('body').width()", $('body').width())

  // setTimeout(() => {
  //   dispatch(setHasScroll(window.innerWidth !== $('body').width() ? true : false))
  // },1000)

  // useEffect(() => {
  //   return () => {
  //     console.log("TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT")
  //   }
  // })

  window.onbeforeunload = function() { // CLEAR FORM: SAVED && FIRES WHEN WINDOW IS CLOSED OR REFRESH
    // if (recipeCreated.current) {
    //   clearHandler() // RESET ALL FORM
    // }

    // if (!userData.email && landingHiddenLS && JSON.parse(landingHiddenLS)) {
    //   console.log("TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT")
    //   localStorage.removeItem('landingHidden');
    // }
    
    //console.log("CLOSED TTTTTTTTTTTTTTTTTTTTTTTTTTTTTTTT")
    //console.log("CLOSED TTTTT TAB", tabIDCopy.current)
    console.log("CLOSED TTTTT ARRAY", eDataCopy.current)
    let rr = eDataCopy.current.subscribe
    //let qq = e.data.unsubscribe[0]
    let ss = rr.filter((e:any) => e !== tabIDCopy.current)

    //bc.postMessage({ subscribe: eDataCopy.current.subscribe ,unsubscribe: [tabIDCopy.current] })
    bc.postMessage({ subscribe: ss, unsubscribe: [tabIDCopy.current] })
    //bc.postMessage({ subscribe: ss })
    return ""
    //console.log("CLOSED TTTTT ARRAY", eDataCopy.current.subscribe === undefined ? "LAST TAB" : null)
    //bc.onmessage = (e) => {}
    //bc.postMessage(arrTabID);

    //let qq = eDataCopy.current && eDataCopy.current.filter((e:any) => e !== tabIDCopy.current)
    //eDataCopy.current = eDataCopy.current && eDataCopy.current.filter((e:any) => e !== tabIDCopy.current)
    //bc.postMessage(eDataCopy.current)
    
    //bc.postMessage([11])
    //return ""
    //bc.close()
    

    //eDataCopy.current && bc.postMessage(eDataCopy.current.filter((e:any) => e !== tabIDCopy.current));
    
    // bc.onmessage = (e) => {

    // }
    

    //return ""
    //alert("Asdasd")
    //bc.postMessage(arrTabID)

    // let tabsLS: string | null = localStorage.getItem('tabsLS');

    // if (tabsLS && JSON.parse(tabsLS)) {
    //   let qq = JSON.parse(tabsLS)
    //   if (qq.length === 1) localStorage.removeItem('tabsLS');
    //   else {
    //     qq.pop()
    //     //console.log("RRRR qq", qq)
    //     //alert(qq)
    //     localStorage.setItem('tabsLS', JSON.stringify(qq))
    //   }
    // }

  }

  

  //if (document.hasFocus()) console.log("ASD FOCUSED DOCUMENT")

  window.onfocus = function() { // FIRED WHEN TAB IS FOCUSED, CHECK VALID USER
    
    // if (!(newLoginLS && JSON.parse(newLoginLS))) {
    //   console.log("ASD", "FOCUSED")
    //   checkPrevLogin({ retrieveLogin, userData })
      
    // }
      console.log("ASD", "FOCUSED")
      checkPrevLogin({ retrieveLogin, userData })
  }

  console.log("TTTTTT", userData)

  //console.log("ASDASDASD", window.name)

  

  return (
    <div
      className={css.background}
      style={{ overflow: landingHidden ? 'inherit' : 'hidden' }}
    >
      <Landing retrieveLogin={retrieveLogin} userData={userData} />
      <div
        className={css.wallpaperNav}
        style={{
          display: showHelpBG ? 'flex' : 'none',
          /* overflow: 'hidden' */
        }}
      />
      <div
        className={css.wallpaperBody}
        /* style={{
          overflow: 'hidden'
        }} */
      />
      <Routes>
        <Route path="/" element={<>
          <GoogleAuth retrieveLogin={retrieveLogin} userData={userData} />
          <ServerStatus />
          <NavBar />
          <Paginate />
          <CardsMapper retrieveLogin={retrieveLogin} userData={userData} />
          <GoUp />
        </>}/>
        
        
        <Route path="/:recipeId" element={<>
          <NavBar />
          <GoogleAuth retrieveLogin={retrieveLogin} userData={userData} />
          <ServerStatus />
          {/* <GoBack recipeNotFound={recipeNotFound} /> */}
          <Detail
            retrieveLogin={retrieveLogin}
            userData={userData}
            retrieveRecipeNotFound={retrieveRecipeNotFound}
          />
        </>}/>
        <Route path="/MyRecipe/" element={<>
          <NavBar />
          <GoogleAuth retrieveLogin={retrieveLogin} userData={userData} />
          <ServerStatus />
          {/* <GoBack recipeCreatedOrEdited={recipeCreatedOrEdited} /> */}
          <MyRecipe
            retrieveLogin={retrieveLogin}
            userData={userData}
            retrieveRecipeCreatedOrEdited={retrieveRecipeCreatedOrEdited}
            recipeCreatedOrEdited={recipeCreatedOrEdited}
          />
        </>}/>
        <Route path="/About" element={<>
          <About />
        </>}/>
        <Route path="/*" element={<>
          <GoBack />
          <Error />
        </>}/>
      </Routes>
    </div>
  )
}

export default App;